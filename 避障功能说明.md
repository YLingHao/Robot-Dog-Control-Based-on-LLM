# 避障功能集成说明

## 概述

已将 `5_obstacle_avoidance` 项目的避障功能集成到 `dog_llm_exec` 项目中，实现机器狗运动时自动避障功能。

## 功能特性

1. **雷达检测障碍物**：检测前方障碍物（距离 < 0.4m），自动执行避障序列
2. **图像识别检测**：
   - 检测楼梯：检测到楼梯时暂停机器狗
   - 检测坑洞：检测到坑洞时暂停机器狗
3. **避障序列**：检测到障碍物时，自动执行避障动作序列（左转-前进-右转-前进-左转）

## 文件结构

新增/修改的文件：

```
dog_llm_exec/
├── obstacle_avoidance.py          # 避障管理器类
├── obstacle_model_cap.py          # 图像推理模块（检测楼梯/坑洞）
├── avoidance_models/              # 避障模型目录
│   ├── 1.om                       # 昇腾AI模型文件（需要从原项目复制）
│   └── predefined_classes.txt     # 类别标签文件（staircase, hole）
└── dog_llm_exec.py                # 已集成避障功能
```

## 使用方法

### 1. 复制模型文件

需要从 `5_obstacle_avoidance/ascend/ObstacleAvoidance/avoidance_models/` 目录复制以下文件到 `dog_llm_exec/avoidance_models/`：

- `1.om` - 昇腾AI模型文件（用于检测楼梯和坑洞）

### 2. 启用避障功能

避障功能默认启用。在创建 `DogCommandExecutor` 时可以控制：

```python
# 启用避障（默认）
executor = DogCommandExecutor(dog_ip="192.168.1.100", enable_obstacle_avoidance=True)

# 禁用避障
executor = DogCommandExecutor(dog_ip="192.168.1.100", enable_obstacle_avoidance=False)
```

### 3. 自动避障

当机器狗执行移动动作（`move_x`, `move_y`, `move_yaw`）时，会自动检测：

- **障碍物**：雷达检测到前方障碍物（距离 <= 0.4m）时，自动停止当前动作，执行避障序列，然后继续剩余路径
- **楼梯**：摄像头检测到楼梯时，自动暂停机器狗
- **坑洞**：摄像头检测到坑洞时，自动暂停机器狗

## 工作原理

1. **初始化**：
   - 创建 `ObstacleAvoidanceManager` 实例
   - 启动雷达检测线程（监听前方距离）
   - 启动摄像头检测线程（使用AI模型检测楼梯/坑洞）

2. **执行动作时**：
   - 在执行移动动作（`move_x`）时，每100ms检测一次：
     - 雷达距离是否 <= 0.4m（障碍物）
     - 摄像头是否检测到楼梯
     - 摄像头是否检测到坑洞

3. **避障处理**：
   - **障碍物**：停止当前动作 → 执行避障序列 → 计算剩余距离 → 继续前进
   - **楼梯/坑洞**：停止当前动作 → 发送暂停指令

## 避障序列

避障序列动作（参考 `obstacle_main.py`）：

1. 左转 -46度
2. 前进 0.7米
3. 右转 91度
4. 前进 0.7米
5. 左转 -30度

## 注意事项

1. **模型文件**：需要确保 `avoidance_models/1.om` 文件存在，否则摄像头检测功能不可用
2. **摄像头依赖**：摄像头检测需要 `camera/HKcamera.py` 和 `camera/det_utils.py` 模块
3. **雷达依赖**：雷达检测需要机器狗支持雷达功能，并已开启雷达（代码中会自动开启）
4. **性能影响**：避障检测在后台线程运行，不会阻塞主程序，但会增加一定的CPU/GPU使用

## 日志输出

避障功能会输出以下日志：

- `避障管理器：雷达检测已启动`
- `避障管理器：摄像头检测已启动`
- `检测到障碍物（距离 <= 0.4m），执行避障...`
- `执行避障序列...`
- `避障序列执行完成`
- `检测到楼梯，暂停机器狗...`
- `检测到坑洞，暂停机器狗...`

## 故障排除

1. **避障功能未启用**：
   - 检查日志中是否有 "避障功能已启用" 消息
   - 检查是否有导入错误或初始化异常

2. **摄像头检测不可用**：
   - 检查 `avoidance_models/1.om` 文件是否存在
   - 检查 `camera/HKcamera.py` 和 `camera/det_utils.py` 是否存在
   - 检查是否有昇腾AI SDK依赖

3. **雷达检测不可用**：
   - 检查机器狗是否支持雷达功能
   - 检查雷达是否已正确开启（代码会自动开启）

## 兼容性

- 避障功能不影响现有功能，如果避障模块不可用，程序会降级运行（不启用避障）
- 所有避障检测都在后台线程运行，不会阻塞动作执行
- 避障功能可以随时启用/禁用，不影响其他功能
