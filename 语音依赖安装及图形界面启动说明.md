# 机器狗语音依赖安装配置说明

本文档说明如何安装和配置语音输入功能所需的依赖，以及如何配置启动脚本中的 Python 路径。

---

## 目录

1. [安装 FFmpeg 并配置环境变量](#1-安装-ffmpeg-并配置环境变量)
2. [安装 Python 依赖库](#2-安装-python-依赖库)
3. [配置启动脚本中的 Python 路径](#3-配置启动脚本中的-python-路径)

---

## 1. 安装 FFmpeg 并配置环境变量

FFmpeg 是 Whisper 进行音频处理所需的工具。

### 1.1 下载 FFmpeg

1. 访问 FFmpeg 官网：https://ffmpeg.org/download.html
2. 选择 Windows 版本下载（推荐使用 [Gyan.dev](https://www.gyan.dev/ffmpeg/builds/) 或 [BtbN](https://github.com/BtbN/FFmpeg-Builds/releases) 提供的预编译版本）
3. 下载完成后解压到一个固定目录，例如：`C:\ffmpeg`

### 1.2 配置环境变量

#### 方法一：通过图形界面配置（推荐）

1. 右键点击「此电脑」→「属性」
2. 点击「高级系统设置」
3. 在「系统属性」窗口中，点击「环境变量」按钮
4. 在「系统变量」区域，找到 `Path` 变量，点击「编辑」
5. 点击「新建」，输入 FFmpeg 的 `bin` 目录路径，例如：`C:\ffmpeg\bin`
6. 点击「确定」保存所有更改
7. **重要**：关闭所有已打开的终端窗口，重新打开一个新的终端窗口

#### 方法二：通过命令行配置（临时）

```cmd
setx PATH "%PATH%;C:\ffmpeg\bin"
```

**注意**：使用 `setx` 后需要重新打开终端窗口才能生效。

### 1.3 验证安装

打开新的命令提示符（CMD）或 PowerShell，执行：

```cmd
ffmpeg -version
```

如果显示 FFmpeg 版本信息，说明安装成功。如果提示「不是内部或外部命令」，请检查：
- 环境变量路径是否正确
- 是否已重新打开终端窗口
- FFmpeg 的 `bin` 目录中是否包含 `ffmpeg.exe`

---

## 2. 安装 Python 依赖库

以下依赖需要在 **安装有pytorch的虚拟环境**中安装。

### 2.1 激活 pytorch 环境

打开命令提示符（CMD）或 PowerShell，执行：

```cmd
conda activate pytorch
```

如果提示找不到 `conda` 命令，请先激活 Anaconda：
```cmd
call "E:\Anaconda3\Scripts\activate.bat"
conda activate pytorch
```

### 2.2 安装 Whisper

Whisper 是 OpenAI 提供的语音转文本模型。

```cmd
pip install -U openai-whisper
```

**注意**：首次使用 Whisper 时会自动下载模型文件（small 模型约 500MB），请确保网络连接正常。

### 2.3 安装 sounddevice

`sounddevice` 用于录制麦克风音频。

```cmd
pip install sounddevice
```

**注意**：如果遇到音频设备相关错误，可能需要安装额外的音频后端：
```cmd
pip install sounddevice[portaudio]
```

### 2.4 安装 scipy

`scipy` 用于音频文件处理（WAV 格式）。

```cmd
pip install scipy
```


### 2.5 验证安装

在 pytorch 环境中执行以下命令，检查是否安装成功：

```cmd
python -c "import whisper; import sounddevice; import scipy; print('所有依赖已安装成功！')"
```

如果没有报错，说明安装成功。

---

## 3. 配置启动脚本中的 Python 路径

`双击启动图形界面.bat` 文件用于启动图形界面程序，需要指定正确的 Python 解释器路径。

### 3.1 查找 Python 路径

#### 方法一：通过 conda 查找（推荐）

1. 打开命令提示符（CMD）或 PowerShell
2. 激活 pytorch 环境：
   ```cmd
   conda activate pytorch
   ```
3. 查询 Python 路径：
   ```cmd
   where python
   ```
   或者：
   ```cmd
   python -c "import sys; print(sys.executable)"
   ```

#### 方法二：通过文件资源管理器查找

1. 打开文件资源管理器
2. 导航到 Anaconda 安装目录，例如：`E:\Anaconda3`
3. 进入 `envs\pytorch` 目录
4. 找到 `python.exe` 文件，完整路径例如：`E:\Anaconda3\envs\pytorch\python.exe`

### 3.2 修改启动脚本

1. 找到 `双击启动图形界面.bat` 文件（位于 `host side` 目录）
2. 右键点击文件，选择「编辑」（或使用记事本打开）
3. 找到以下行：
   ```batch
   set "PYTORCH_PYTHON=E:\Anaconda3\python.exe"
   ```
4. 将路径修改为你实际的 Python 路径，例如：
   ```batch
   set "PYTORCH_PYTHON=E:\Anaconda3\envs\pytorch\python.exe"
   ```
5. 保存文件

### 3.3 启动脚本说明

`双击启动图形界面.bat` 文件内容示例：

```batch
@echo off
REM 使用 Anaconda 中的 pytorch 虚拟环境启动 GUI
REM 如路径有变化，请修改下面这一行 python.exe 的路径
set "PYTORCH_PYTHON=E:\Anaconda3\envs\pytorch\python.exe"

chcp 65001 >nul
echo 使用环境: %PYTORCH_PYTHON%
echo 正在启动机器人 LLM 图形界面...
echo.

"%PYTORCH_PYTHON%" "%~dp0llm_forwarder_gui.py"

echo.
pause
```

**关键说明**：
- `set "PYTORCH_PYTHON=..."`：设置 Python 解释器的完整路径
- `%~dp0`：表示批处理文件所在的目录
- `chcp 65001`：设置代码页为 UTF-8，确保中文显示正常

### 3.4 常见问题

#### 问题 1：找不到 Python 文件

**解决方法**：
- 确认 Anaconda 安装路径是否正确
- 确认 pytorch 环境是否存在：`conda env list`
- 如果环境不存在，创建环境：`conda create -n pytorch python=3.x`

#### 问题 2：启动后提示缺少模块

**解决方法**：
- 确认使用的是 pytorch 环境的 Python，而不是 base 环境的 Python
- 在 pytorch 环境中重新安装缺失的模块

#### 问题 3：中文显示乱码

**解决方法**：
- 确认批处理文件已保存为 UTF-8 编码
- 确认 `chcp 65001` 命令已包含在脚本中

---

## 4. 完整安装检查清单

在开始使用前，请确认以下项目：

- [ ] FFmpeg 已安装并配置环境变量（可通过 `ffmpeg -version` 验证）
- [ ] pytorch 环境已激活
- [ ] Whisper 已安装（`pip install -U openai-whisper`）
- [ ] sounddevice 已安装（`pip install sounddevice`）
- [ ] scipy 已安装（`pip install scipy`）
- [ ] `双击启动图形界面.bat` 中的 Python 路径已正确配置
- [ ] 所有依赖验证通过（`python -c "import whisper; import sounddevice; import scipy; print('OK')"`）

---

## 5. 快速安装命令（一键执行）

如果你已经激活了 pytorch 环境，可以一次性安装所有 Python 依赖：

```cmd
conda activate pytorch
pip install -U openai-whisper sounddevice scipy opencc-python-reimplemented
```

---

## 6. 技术支持

如果遇到问题，请检查：
1. Python 版本是否兼容（推荐 Python 3.8+）
2. 网络连接是否正常（Whisper 首次使用需要下载模型）
3. 麦克风权限是否已授予应用程序
4. 音频设备是否正常工作

---

**文档版本**：v1.0  
**最后更新**：2026-01-15
